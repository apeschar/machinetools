#!/bin/bash

set -euo pipefail

if [[ $# -ne 1 ]]; then
	echo "Usage: $0 <name>" >&2
	exit 1
fi

machine="$1"
zfs_name="rpool/var/lib/machines/$machine"
root="/var/lib/machines/$machine"

zfs create "$zfs_name"

debootstrap buster "$root"

tee "$root/etc/network/interfaces.d/host0" <<EOF
auto host0
iface host0 inet dhcp
EOF

systemd-nspawn --machine="$machine" -U apt update
systemd-nspawn --machine="$machine" -U apt install -y dbus
